---
title: "MATH 284/FMPH 291 Survival Analysis  Supplementary Learing Materials"
author: "Yuyao Wang"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Tutorial

Here is the link of a tutorial for survival analysis in R by Emily C. Zabor:
[https://www.emilyzabor.com/tutorials/survival_analysis_in_r_tutorial.html#Part_1:_Introduction_to_Survival_Analysis](https://www.emilyzabor.com/tutorials/survival_analysis_in_r_tutorial.html#Part_1:_Introduction_to_Survival_Analysis)

Part 1 in the above tutorial includes creating survival objects and curve, Kaplan-Meier plots, Estimating x-year survival, estimating median survival time, comparing survival times between groups (using log-rank test), and Cox regression model.

Below are some additional material for different topics.




# Kaplan-Meier Curve

The tutorial uses the '\texttt{ggsurvfit}' R package for doing Kaplan-Meier plots. Alternatively, survival plots can be created using base R or the '\texttt{survminer}' package.
For example, below is an example of fiting KM curves for the two sex groups using the ‘lung’ data set from the '\texttt{survival}’ R package. You may find more details of the usage of the functions (for example how to add confidence intervals) by checking the R document for \texttt{survfit()} and \texttt{plot.survfit()}.

```{r r1_KM}
# Load the survival package
library(survival)
# Fit the Kaplan-Meier model stratified by sex
# The lung dataset is automatically available after loading the survival package
km_fit <- survfit(Surv(time, status) ~ sex, data = lung)
# Plotting the Kaplan-Meier curves for two sex groups
plot(km_fit, main = "Kaplan-Meier Survival Curves by Sex",
        xlab = "Days", ylab = "Survival Probability", col = c(1, 2), lty = 1:2)
# Adding a legend to the plot
legend("topright", legend = c("Male", "Female"), col = c(1, 2), lty = 1:2)
```




# Log-rank test

The function \texttt{survdiff()} used in the above tutorial for comparing survival times between groups is a function that conduct G-rho family tests. The default \texttt{rho=0}, which corresponds to log-rank test. More details can be found in the R documentation of this package.
An alternative way of doing logrank test is using the score test for coxph score test. Try the code below, and you will find the two approaches gives exactly the same results! 

BTW, \texttt{survdiff()} does not handle left truncated data, but `coxph()` can properly handle it by specifying the survival object to be `Surv(Q,X,Delta)`, where Q is the left truncation time, X is the censored event time, and Delta is the event indicator.

```{r r_longrank}
# logrank test using G^\rho test with rho = 0
logrank.1 = survdiff(Surv(time, status) ~ sex, data = lung)
print(logrank.1)

# logrank test using coxph score test
coxphfit = coxph(Surv(time, status) ~ sex, data = lung)
summary(coxphfit)
```







# The dual between estimating T distribution and estimating C distribution

The observed censored event time $X = \min(T,C)$ not only contains information of the event time $T$, but also information of the censoring time $C$. The even indicator $\Delta = I(T<C)$. In other words, when $\Delta = 1$, $X = T$; when $\Delta = 0$, $X = C$. 

When we focus on estimating $T$ distribution, $T$ is censored by $C$, we construct survival object using `Surv(X, delta)`. When we focus on estimating $C$ distribution, $C$ can be viewed as censored by $T$. With this point of view think about how can we construct the survival object.





# Notes on the exponenetial model and weibull model fitted using `survreg()`

The location-scale parameterization of a Weibull distribution found in `survreg` is not the same as the parameterization of rweibull. See the Example for `survreg()` and the chunk for `survreg.distributions` in ‘\texttt{survival}’ R package documentation for more details on how to interpret the outputs.

When fitting an exponential model using `fit = survreg(..., dist = "exponential")`, `1/exp(fit$icoef)` correspond to the rate parameter in `rexp()`. Try the example below.

```{r r_survreg_exp}
n=10000
lambda = 3
TT = rexp(n, rate = lambda)
C = runif(n, 1, 2)
X = pmin(TT,C)
delta = as.numeric(TT<C)

dat = data.frame(X = X, delta = delta)

fit = survreg(Surv(X, delta)~1, data = dat, dist = "exponential")
1/exp(fit$icoef)
```




# Cox regression

We will use the `lung` data set in the `survival` R package as an example.

```{r coxph_data}
summary(lung)
```

## Fitting the model

Try whether you get the same result if you change the data type for `sex` into factor.
How to interpret the results when using `sex` as a continuous variable and when using `sex` as a factor?

```{r coxph}
# lung$sex <- as.factor(lung$sex)  
coxfit = coxph(Surv(time, status) ~ sex, data = lung)
coxfit

ss = summary(coxfit)
ss

# Extract the coefficient 
coef(coxfit)
# or
coxfit$coefficients

# Extract the coefficients and p-value from Wald test
coef(ss)
# or
ss$coefficients
```


## Prediction

Note that when using `basehaz()` to get the estimator of cumulative baseline hazard, one should use the argument `center = FALSE` in order to get the estimate for the cumulative baseline hazard function $\Lambda_0(t)$ in the slides. See the example below.

When using `center = FALSE` in `basehaz()`, one need to further center the covariate values when using the formula:

$$\hat S(t|Z) = e^{-\hat\Lambda_0(t) e^{\hat\beta^\top Z}}.$$

See the example below.

```{r coxph_predict}
coxfit = coxph(Surv(time, status) ~ ph.karno, data = lung)
coxfit

ph.karno.new = 75

## Compute the baseline hazard
baseh = basehaz(coxfit, center = FALSE)
beta = coef(coxfit)

baseh_centerT = basehaz(coxfit, center = TRUE)

newdat = data.frame(time = baseh$time, 
                    status = 1, 
                    ph.karno = ph.karno.new)
                 
pred = predict(coxfit, newdata = newdat, type = "survival", se.fit = TRUE)
pred_surv  = pred$fit
# To see more usage of the function `prediction()` for `coxph` object, try the following.
# ?predict.coxph

# Another method - Compute the estimates from `beta` and `baseh`
# sex = 1 -> to the baseline survival, since sex = 1 is the reference group
pred2_surv_stepf <- stepfun(baseh$time, c(1, exp(-baseh$hazard*exp(beta*ph.karno.new))))
pred3_surv_stepf <- stepfun(baseh_centerT$time, c(1, exp(-baseh_centerT$hazard*exp(beta*ph.karno.new))))
pred4_surv_stepf <- stepfun(baseh_centerT$time, c(1, exp(-baseh_centerT$hazard*exp( beta*(ph.karno.new - mean(lung$ph.karno, na.rm = TRUE)) ))))

## Plot out the step function for the estimated survival curve
pred_surv_stepf <- stepfun(newdat$time, c(1,pred_surv))
plot(pred_surv_stepf, do.points = FALSE, col = 1, lty = 1,
     main = "Predicted survival curves",
     xlab = "Days", ylab = "Survival probability")
# ?plot.stepfun  # for more usage of plotting the `stepfun` object
plot(pred2_surv_stepf, do.points = FALSE, col = 2, lty = 2, add = TRUE)
plot(pred3_surv_stepf, do.points = FALSE, col = 3, lty = 3, add = TRUE)
plot(pred4_surv_stepf, do.points = FALSE, col = 4, lty = 4, add = TRUE)
legend("topright", 
       legend = c("predict.coxph", "center = FALSE, orginal Z", "center = TRUE, orginal Z", "center = TRUE, centered Z"),
       col = 1:4, lty = 1:4,
       bty = "n")
```

See the R documentation for `predict.coxph()` for details about how to do prediction.


Another way to do prediction is using the `hasehaz(.., newdata)`.

```{r coxph_predict2}
newdat = data.frame(ph.karno = ph.karno.new)
cumhazard = basehaz(coxfit, newdata = newdat)

pred5_surv_stepf <- stepfun(baseh$time, c(1, exp(-cumhazard$hazard)))

plot(pred_surv_stepf, do.points = FALSE, col = 1, lty = 1,
     main = "Predicted survival curves",
     xlab = "Days", ylab = "Survival probability")
plot(pred5_surv_stepf, do.points = FALSE, col = 5, lty = 5, add = TRUE)
legend("topright", 
       legend = c("predict.coxph", "basehaz"),
       col = c(1,5), lty = c(1,5),
       bty = "n")


# To predict multiple survival curves at once
ph.karno.new = c(60, 75, 90)
newdat = data.frame(ph.karno = ph.karno.new)
cumhazard = basehaz(coxfit, newdata = newdat)
colnames(cumhazard)

surv_stepf <- stepfun(cumhazard$time, c(1, exp(-cumhazard[,1])))
plot(surv_stepf, do.points = FALSE, col = 1, lty = 1,
     main = "Predicted survival curves",
     xlab = "Days", ylab = "Survival probability")
k = nrow(newdat)
for(i in 2:k){
    surv_stepf <- stepfun(cumhazard$time, c(1, exp(-cumhazard[,i])))
    plot(surv_stepf, do.points = FALSE, col = i, lty = i, add = TRUE)
}
legend("topright", 
       legend = paste("ph.karno =",  ph.karno.new),
       col = 1:k, lty = 1:k,
       bty = "n")

```

